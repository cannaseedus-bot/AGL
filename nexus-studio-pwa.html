<!DOCTYPE html>
<!-- nexus-studio-pwa.html -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Studio - Build Apps Instantly</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('Service Worker Failed:', err));
        }
    </script>

    <style>
        /* NEXUS STUDIO PWA THEME */
        :root {
            --nexus-bg: #0a0a0f;
            --nexus-surface: #1a1a24;
            --nexus-elevated: #232331;
            --nexus-cyan: #00f3ff;
            --nexus-purple: #a855f7;
            --nexus-pink: #ec4899;
            --nexus-text: #f8fafc;
            --nexus-text-secondary: #cbd5e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--nexus-bg);
            color: var(--nexus-text);
            font-family: 'Inter', system-ui, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--nexus-surface);
            border: 2px solid var(--nexus-cyan);
            border-radius: 12px;
            padding: 16px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.3s ease;
        }

        .install-prompt.show {
            display: flex;
        }

        /* Main Container */
        .nexus-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100vh;
            transition: all 0.3s ease;
        }

        /* Collapsed for mobile/tablet */
        @media (max-width: 1024px) {
            .nexus-container {
                grid-template-columns: 0 1fr;
            }

            .nexus-container.sidebar-open {
                grid-template-columns: 280px 1fr;
            }
        }

        /* Sidebar */
        .sidebar {
            background: var(--nexus-surface);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nexus-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--nexus-cyan), var(--nexus-purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 20px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: var(--nexus-text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--nexus-text);
        }

        .nav-item.active {
            background: rgba(0, 243, 255, 0.1);
            color: var(--nexus-cyan);
            border-right: 3px solid var(--nexus-cyan);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            height: 60px;
            background: var(--nexus-surface);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--nexus-text);
            font-size: 24px;
            cursor: pointer;
        }

        @media (max-width: 1024px) {
            .menu-toggle {
                display: block;
            }
        }

        /* CLI Widget (Docker-style) */
        .cli-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--nexus-cyan);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 243, 255, 0.3);
            z-index: 9999;
            transition: all 0.3s ease;
        }

        .cli-widget:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(0, 243, 255, 0.4);
        }

        .cli-widget.active {
            width: 600px;
            height: 400px;
            border-radius: 16px;
            bottom: 20px;
            right: 20px;
        }

        .cli-widget.active .terminal-icon {
            display: none;
        }

        .terminal-icon {
            font-size: 24px;
            color: var(--nexus-bg);
        }

        /* CLI Modal */
        .cli-modal {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            background: var(--nexus-bg);
            border-radius: 16px;
            overflow: hidden;
            border: 2px solid var(--nexus-cyan);
        }

        .cli-widget.active .cli-modal {
            display: flex;
        }

        .cli-header {
            padding: 16px 20px;
            background: var(--nexus-surface);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cli-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .cli-close {
            background: rgba(255, 255, 255, 0.1);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cli-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .cli-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .cli-input {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: var(--nexus-surface);
            display: flex;
            gap: 12px;
        }

        .cli-prompt {
            color: var(--nexus-cyan);
            font-weight: 600;
        }

        .cli-command {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--nexus-text);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            outline: none;
        }

        /* Tab System */
        .tabs-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            background: var(--nexus-surface);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            border-bottom-color: var(--nexus-cyan);
            color: var(--nexus-cyan);
        }

        .tab-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .tab-pane {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Welcome Screen */
        .welcome-screen {
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .welcome-title {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--nexus-cyan), var(--nexus-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .welcome-subtitle {
            font-size: 20px;
            color: var(--nexus-text-secondary);
            margin-bottom: 40px;
        }

        .quick-start-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .quick-start-card {
            background: var(--nexus-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-start-card:hover {
            border-color: var(--nexus-cyan);
            transform: translateY(-4px);
        }

        /* App Builder Canvas */
        .app-canvas {
            width: 100%;
            height: 100%;
            background: var(--nexus-bg);
            position: relative;
            overflow: auto;
        }

        .component-palette {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--nexus-surface);
            border-radius: 12px;
            padding: 16px;
            width: 240px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .component-item {
            padding: 12px;
            border-radius: 8px;
            cursor: grab;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .component-item:hover {
            background: rgba(0, 243, 255, 0.1);
        }

        /* Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--nexus-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--nexus-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .cli-widget.active {
                width: calc(100vw - 40px);
                height: 300px;
                bottom: 10px;
                right: 10px;
            }

            .welcome-title {
                font-size: 32px;
            }

            .welcome-subtitle {
                font-size: 16px;
            }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--nexus-surface);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: rotate(30deg);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
    </div>

    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div>üì± Install Nexus Studio for offline use</div>
        <button id="installButton" style="background: var(--nexus-cyan); color: var(--nexus-bg); border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Install
        </button>
        <button id="dismissInstall" style="background: transparent; color: var(--nexus-text-secondary); border: none; cursor: pointer;">
            Dismiss
        </button>
    </div>

    <!-- Main Container -->
    <div class="nexus-container" id="mainContainer">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="nexus-logo">N</div>
                <div>
                    <div style="font-weight: 700; font-size: 18px;">Nexus Studio</div>
                    <div style="font-size: 12px; color: var(--nexus-text-secondary);">v1.0</div>
                </div>
            </div>

            <div class="sidebar-nav">
                <div class="nav-item active" data-tab="welcome">
                    üè† Welcome
                </div>
                <div class="nav-item" data-tab="builder">
                    üõ†Ô∏è App Builder
                </div>
                <div class="nav-item" data-tab="components">
                    üß© Components
                </div>
                <div class="nav-item" data-tab="apis">
                    ‚ö° APIs
                </div>
                <div class="nav-item" data-tab="projects">
                    üìÅ Projects
                </div>
                <div class="nav-item" data-tab="settings">
                    ‚öôÔ∏è Settings
                </div>
                <div class="nav-item" data-tab="help">
                    ‚ùì Help
                </div>
            </div>

            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 12px; color: var(--nexus-text-secondary); margin-bottom: 8px;">
                    User: <span id="currentUser">Guest</span>
                </div>
                <button id="loginButton" style="width: 100%; background: rgba(0, 243, 255, 0.1); color: var(--nexus-cyan); border: 1px solid var(--nexus-cyan); border-radius: 6px; padding: 8px; cursor: pointer;">
                    üë§ Login / Register
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <button class="menu-toggle" id="menuToggle">
                    ‚ò∞
                </button>
                <div style="display: flex; gap: 20px; align-items: center;">
                    <button id="newProject" style="background: var(--nexus-cyan); color: var(--nexus-bg); border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        + New Project
                    </button>
                    <button id="importProject" style="background: transparent; color: var(--nexus-text); border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        Import
                    </button>
                </div>
            </div>

            <!-- Tabs Content -->
            <div class="tabs-container">
                <div class="tabs-header" id="tabsHeader">
                    <!-- Dynamic tabs will be added here -->
                </div>

                <div class="tab-content" id="tabContent">
                    <!-- Welcome Tab -->
                    <div class="tab-pane active" id="welcome-tab">
                        <div class="welcome-screen">
                            <h1 class="welcome-title">Build Apps Instantly</h1>
                            <p class="welcome-subtitle">
                                Drag, drop, describe. Nexus Studio builds full applications with AI,
                                stores everything locally, and deploys anywhere. No installation needed.
                            </p>

                            <div class="quick-start-grid">
                                <div class="quick-start-card" onclick="openTab('builder')">
                                    <h3 style="margin-bottom: 12px;">üöÄ Quick Start</h3>
                                    <p style="color: var(--nexus-text-secondary); font-size: 14px;">
                                        Start from template or describe what you want to build
                                    </p>
                                </div>

                                <div class="quick-start-card" onclick="openTab('components')">
                                    <h3 style="margin-bottom: 12px;">üß© Component Library</h3>
                                    <p style="color: var(--nexus-text-secondary); font-size: 14px;">
                                        Drag and drop pre-built components
                                    </p>
                                </div>

                                <div class="quick-start-card" onclick="openTab('apis')">
                                    <h3 style="margin-bottom: 12px;">‚ö° Connect APIs</h3>
                                    <p style="color: var(--nexus-text-secondary); font-size: 14px;">
                                        Add AI, data, authentication with one click
                                    </p>
                                </div>

                                <div class="quick-start-card" onclick="openTab('projects')">
                                    <h3 style="margin-bottom: 12px;">üìÅ Open Project</h3>
                                    <p style="color: var(--nexus-text-secondary); font-size: 14px;">
                                        Continue working on existing projects
                                    </p>
                                </div>
                            </div>

                            <div style="margin-top: 40px; padding: 20px; background: var(--nexus-surface); border-radius: 12px;">
                                <h3 style="margin-bottom: 16px;">üí° How it works:</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--nexus-cyan);">1. Describe</div>
                                        <div style="font-size: 14px; color: var(--nexus-text-secondary);">
                                            Tell AI what you want to build
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--nexus-cyan);">2. Drag & Drop</div>
                                        <div style="font-size: 14px; color: var(--nexus-text-secondary);">
                                            Arrange components visually
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--nexus-cyan);">3. Connect</div>
                                        <div style="font-size: 14px; color: var(--nexus-text-secondary);">
                                            Link APIs and data sources
                                        </div>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--nexus-cyan);">4. Deploy</div>
                                        <div style="font-size: 14px; color: var(--nexus-text-secondary);">
                                            One-click deploy to web
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- App Builder Tab -->
                    <div class="tab-pane" id="builder-tab">
                        <div class="app-canvas" id="appCanvas">
                            <div class="component-palette">
                                <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--nexus-cyan);">Components</h3>
                                <div class="component-item" draggable="true" data-type="hero">
                                    üéØ Hero Section
                                </div>
                                <div class="component-item" draggable="true" data-type="card">
                                    üÉè Content Card
                                </div>
                                <div class="component-item" draggable="true" data-type="form">
                                    üìù Contact Form
                                </div>
                                <div class="component-item" draggable="true" data-type="nav">
                                    üß≠ Navigation
                                </div>
                                <div class="component-item" draggable="true" data-type="grid">
                                    üìä Data Grid
                                </div>
                                <div class="component-item" draggable="true" data-type="chart">
                                    üìà Chart
                                </div>
                            </div>

                            <!-- Dropped components will appear here -->
                            <div id="canvasArea" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                                <div style="position: absolute; top: 100px; left: 300px; width: 800px; height: 400px; border: 2px dashed rgba(0, 243, 255, 0.3); border-radius: 12px; padding: 20px;">
                                    <h2 style="color: var(--nexus-cyan); margin-bottom: 16px;">Your App Canvas</h2>
                                    <p style="color: var(--nexus-text-secondary);">Drag components here from the palette</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Components Tab -->
                    <div class="tab-pane" id="components-tab">
                        <div style="padding: 40px;">
                            <h2 style="margin-bottom: 24px; color: var(--nexus-cyan);">Component Library</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                                <!-- Components will be dynamically loaded -->
                            </div>
                        </div>
                    </div>

                    <!-- APIs Tab -->
                    <div class="tab-pane" id="apis-tab">
                        <div style="padding: 40px;">
                            <h2 style="margin-bottom: 24px; color: var(--nexus-cyan);">API Connections</h2>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: var(--nexus-surface); padding: 24px; border-radius: 12px; cursor: pointer;" onclick="connectAPI('openai')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #74aa9c, #10a37f); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                            ‚ö°
                                        </div>
                                        <div style="font-weight: 600;">OpenAI</div>
                                    </div>
                                    <div style="font-size: 14px; color: var(--nexus-text-secondary);">
                                        GPT-4, DALL-E, Whisper
                                    </div>
                                </div>

                                <div style="background: var(--nexus-surface); padding: 24px; border-radius: 12px; cursor: pointer;" onclick="connectAPI('anthropic')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #d946ef, #a855f7); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                            ‚ö°
                                        </div>
                                        <div style="font-weight: 600;">Anthropic</div>
                                    </div>
                                    <div style="font-size: 14px; color: var(--nexus-text-secondary);">
                                        Claude 3, Sonnet, Haiku
                                    </div>
                                </div>

                                <div style="background: var(--nexus-surface); padding: 24px; border-radius: 12px; cursor: pointer;" onclick="connectAPI('deepseek')">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #00f3ff, #3b82f6); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                            ‚ö°
                                        </div>
                                        <div style="font-weight: 600;">DeepSeek</div>
                                    </div>
                                    <div style="font-size: 14px; color: var(--nexus-text-secondary);">
                                        Code generation, reasoning
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CLI Widget (Docker-style) -->
    <div class="cli-widget" id="cliWidget">
        <div class="terminal-icon">$</div>
        <div class="cli-modal">
            <div class="cli-header">
                <div class="cli-title">
                    <span>$</span>
                    Nexus CLI
                </div>
                <div class="cli-close" id="cliClose">
                    √ó
                </div>
            </div>
            <div class="cli-body" id="cliOutput">
                <div style="color: var(--nexus-cyan);">Nexus CLI v1.0 - Type 'help' for commands</div>
                <div style="margin-top: 10px; color: var(--nexus-text-secondary);">
                    Available commands: build, deploy, api, fs, svg, ai, db
                </div>
                <div id="commandHistory"></div>
                <div style="display: flex; align-items: center; margin-top: 10px;">
                    <span class="cli-prompt">$</span>
                    <input type="text" class="cli-command" id="cliCommand" placeholder="Type command..." autocomplete="off">
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle">
        üåì
    </div>

    <!-- Script -->
    <script>
        // Initialize Nexus Studio PWA
        class NexusStudioPWA {
            constructor() {
                this.currentTab = 'welcome';
                this.cliOpen = false;
                this.deferredPrompt = null;
                this.init();
            }

            init() {
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 300);
                }, 1000);

                // Setup event listeners
                this.setupEventListeners();

                // Check if PWA is installable
                this.setupPWAInstall();

                // Initialize local storage
                this.initLocalStorage();

                // Show welcome message
                this.showToast('üöÄ Nexus Studio Ready');
            }

            setupEventListeners() {
                // Menu toggle
                document.getElementById('menuToggle').addEventListener('click', () => {
                    document.getElementById('mainContainer').classList.toggle('sidebar-open');
                });

                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const tab = e.currentTarget.dataset.tab;
                        this.openTab(tab);

                        // Close sidebar on mobile
                        if (window.innerWidth <= 1024) {
                            document.getElementById('mainContainer').classList.remove('sidebar-open');
                        }
                    });
                });

                // CLI Widget
                document.getElementById('cliWidget').addEventListener('click', (e) => {
                    if (!e.target.closest('.cli-modal')) {
                        this.toggleCLI();
                    }
                });

                document.getElementById('cliClose').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleCLI();
                });

                // CLI Command input
                document.getElementById('cliCommand').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        this.executeCLICommand(e.target.value);
                        e.target.value = '';
                    }
                });

                // Install prompt
                document.getElementById('installButton').addEventListener('click', () => {
                    this.installPWA();
                });

                document.getElementById('dismissInstall').addEventListener('click', () => {
                    document.getElementById('installPrompt').classList.remove('show');
                });

                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });

                // New project
                document.getElementById('newProject').addEventListener('click', () => {
                    this.createNewProject();
                });

                // Import project
                document.getElementById('importProject').addEventListener('click', () => {
                    this.importProject();
                });

                // Drag and drop components
                this.setupDragAndDrop();
            }

            setupPWAInstall() {
                // Check if PWA is installable
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;

                    // Show install prompt after 3 seconds
                    setTimeout(() => {
                        if (this.deferredPrompt) {
                            document.getElementById('installPrompt').classList.add('show');
                        }
                    }, 3000);
                });

                // Check if already installed
                window.addEventListener('appinstalled', () => {
                    this.deferredPrompt = null;
                    document.getElementById('installPrompt').classList.remove('show');
                    this.showToast('‚úÖ Nexus Studio Installed!');
                });
            }

            installPWA() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();

                    this.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        } else {
                            console.log('User dismissed the install prompt');
                        }
                        this.deferredPrompt = null;
                        document.getElementById('installPrompt').classList.remove('show');
                    });
                }
            }

            initLocalStorage() {
                // Initialize IndexedDB for local storage
                if (!window.indexedDB) {
                    console.warn('IndexedDB not supported, using localStorage');
                    return;
                }

                const request = indexedDB.open('NexusStudio', 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    // Create object stores
                    if (!db.objectStoreNames.contains('projects')) {
                        db.createObjectStore('projects', { keyPath: 'id' });
                    }

                    if (!db.objectStoreNames.contains('components')) {
                        db.createObjectStore('components', { keyPath: 'id' });
                    }

                    if (!db.objectStoreNames.contains('apiKeys')) {
                        db.createObjectStore('apiKeys', { keyPath: 'id' });
                    }
                };

                request.onsuccess = () => {
                    console.log('IndexedDB initialized');
                    this.loadInitialData();
                };

                request.onerror = (error) => {
                    console.error('IndexedDB error:', error);
                };
            }

            loadInitialData() {
                // Load saved projects, components, etc.
                // This would be implemented based on actual data structure
            }

            openTab(tabName) {
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.tab === tabName) {
                        item.classList.add('active');
                    }
                });

                // Show corresponding tab content
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('active');
                });

                const tabPane = document.getElementById(`${tabName}-tab`);
                if (tabPane) {
                    tabPane.classList.add('active');
                }

                this.currentTab = tabName;
            }

            toggleCLI() {
                const widget = document.getElementById('cliWidget');
                widget.classList.toggle('active');
                this.cliOpen = !this.cliOpen;

                if (this.cliOpen) {
                    document.getElementById('cliCommand').focus();
                }
            }

            async executeCLICommand(command) {
                const output = document.getElementById('commandHistory');
                const promptLine = document.createElement('div');
                promptLine.innerHTML = `<span style="color: var(--nexus-cyan);">$</span> ${command}`;
                output.appendChild(promptLine);

                // Clear previous output if too many lines
                if (output.children.length > 50) {
                    output.removeChild(output.firstChild);
                }

                // Scroll to bottom
                output.scrollTop = output.scrollHeight;

                // Execute command
                const response = await this.processCommand(command);

                const resultLine = document.createElement('div');
                resultLine.textContent = response;
                resultLine.style.marginBottom = '10px';
                resultLine.style.color = 'var(--nexus-text-secondary)';
                output.appendChild(resultLine);
            }

            async processCommand(command) {
                const [cmd, ...args] = command.trim().split(' ');

                switch (cmd.toLowerCase()) {
                    case 'help':
                        return `Available commands:
  build <type>    - Build project (web, cli, api, svg)
  deploy <target> - Deploy to target (vercel, netlify, github)
  api <action>    - API operations (call, register, list)
  fs <action>     - File system (ls, cat, cp, mv)
  svg <component> - Generate SVG component
  ai <prompt>     - AI operations
  db <action>     - Database operations
  clear          - Clear terminal`;

                    case 'build':
                        return await this.cliBuild(args);

                    case 'deploy':
                        return await this.cliDeploy(args);

                    case 'api':
                        return await this.cliAPI(args);

                    case 'fs':
                        return await this.cliFS(args);

                    case 'svg':
                        return await this.cliSVG(args);

                    case 'ai':
                        return await this.cliAI(args);

                    case 'db':
                        return await this.cliDB(args);

                    case 'clear':
                        document.getElementById('commandHistory').innerHTML = '';
                        return '';

                    case '':
                        return '';

                    default:
                        return `Command not found: ${cmd}. Type 'help' for available commands.`;
                }
            }

            async cliBuild(args) {
                const type = args[0] || 'web';
                this.showToast(`Building ${type} project...`);

                // Simulate build process
                await new Promise(resolve => setTimeout(resolve, 1000));

                return `‚úÖ Built ${type} project successfully!
Output: ./dist/
Files: 45
Size: 2.4 MB
Time: 1.2s`;
            }

            async cliDeploy(args) {
                const target = args[0] || 'vercel';
                this.showToast(`Deploying to ${target}...`);

                await new Promise(resolve => setTimeout(resolve, 1200));

                return `üöÄ Deployed to ${target}!
URL: https://nexus-studio-${target}.app
Status: live`;
            }

            async cliAPI(args) {
                const action = args[0] || 'list';

                switch (action) {
                    case 'list':
                        return 'Available APIs: openai, anthropic, deepseek';
                    case 'register':
                        return 'API registration queued. Use: api list';
                    case 'call':
                        return 'API call queued. Provide payload in next command.';
                    default:
                        return `Unknown api action: ${action}`;
                }
            }

            async cliFS(args) {
                const action = args[0] || 'ls';

                switch (action) {
                    case 'ls':
                        return 'workspace/  dist/  assets/';
                    case 'cat':
                        return 'Usage: fs cat <path>';
                    case 'cp':
                        return 'Usage: fs cp <src> <dest>';
                    case 'mv':
                        return 'Usage: fs mv <src> <dest>';
                    default:
                        return `Unknown fs action: ${action}`;
                }
            }

            async cliSVG(args) {
                const component = args[0] || 'logo';
                return `Generated ${component} SVG and stored in ./assets/${component}.svg`;
            }

            async cliAI(args) {
                const prompt = args.join(' ');
                if (!prompt) return 'Please provide a prompt';

                this.showToast('ü§ñ Processing AI request...');

                // Simulate AI processing
                await new Promise(resolve => setTimeout(resolve, 1500));

                return `AI Response:
${prompt} would be implemented with:
- React components for UI
- Node.js backend for logic
- SCXQ2 glyph compression for assets
- Local IndexedDB for storage`;
            }

            async cliDB(args) {
                const action = args[0] || 'status';

                switch (action) {
                    case 'status':
                        return 'DB status: connected (IndexedDB)';
                    case 'list':
                        return 'Tables: projects, components, apiKeys';
                    case 'reset':
                        return 'DB reset queued. Refresh to reinitialize.';
                    default:
                        return `Unknown db action: ${action}`;
                }
            }

            toggleTheme() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'light';
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');

                this.showToast(isDark ? 'üåô Dark mode' : '‚òÄÔ∏è Light mode');
            }

            createNewProject() {
                this.showModal('New Project', `
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--nexus-text-secondary);">Project Name</label>
                        <input type="text" id="projectName" style="width: 100%; padding: 10px; background: var(--nexus-surface); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: var(--nexus-text);">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--nexus-text-secondary);">Template</label>
                        <select id="projectTemplate" style="width: 100%; padding: 10px; background: var(--nexus-surface); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: var(--nexus-text);">
                            <option value="blank">Blank Project</option>
                            <option value="dashboard">Dashboard</option>
                            <option value="ecommerce">E-commerce</option>
                            <option value="portfolio">Portfolio</option>
                            <option value="saas">SAAS Application</option>
                        </select>
                    </div>

                    <button id="createProjectBtn" style="width: 100%; background: var(--nexus-cyan); color: var(--nexus-bg); border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Create Project
                    </button>
                `);

                document.getElementById('createProjectBtn').addEventListener('click', () => {
                    const name = document.getElementById('projectName').value;
                    const template = document.getElementById('projectTemplate').value;

                    if (name) {
                        this.showToast(`Created project: ${name}`);
                        this.openTab('builder');
                        this.closeModal();
                    }
                });
            }

            importProject() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.nexusbundle,.json,.zip';

                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.showToast(`Importing ${file.name}...`);
                        // Handle import logic
                    }
                };

                input.click();
            }

            setupDragAndDrop() {
                const canvas = document.getElementById('canvasArea');

                document.querySelectorAll('.component-item').forEach(item => {
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('component-type', item.dataset.type);
                        e.dataTransfer.effectAllowed = 'copy';
                    });
                });

                canvas.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                });

                canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const type = e.dataTransfer.getData('component-type');
                    const x = e.clientX - canvas.getBoundingClientRect().left - 100;
                    const y = e.clientY - canvas.getBoundingClientRect().top - 50;

                    this.addComponentToCanvas(type, x, y);
                });
            }

            addComponentToCanvas(type, x, y) {
                const component = document.createElement('div');
                component.className = 'dropped-component';
                component.style.cssText = `
                    position: absolute;
                    left: ${x}px;
                    top: ${y}px;
                    width: 300px;
                    background: var(--nexus-surface);
                    border: 2px solid var(--nexus-cyan);
                    border-radius: 12px;
                    padding: 20px;
                    cursor: move;
                `;

                component.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-weight: 600; color: var(--nexus-cyan);">${type}</div>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; color: var(--nexus-text-secondary); border: none; cursor: pointer;">√ó</button>
                    </div>
                    <div style="color: var(--nexus-text-secondary); font-size: 14px;">
                        ${type} component content
                    </div>
                `;

                document.getElementById('canvasArea').appendChild(component);
                this.makeDraggable(component);

                this.showToast(`Added ${type} component`);
            }

            makeDraggable(element) {
                let isDragging = false;
                let offsetX, offsetY;

                element.addEventListener('mousedown', (e) => {
                    if (e.target.tagName === 'BUTTON') return;

                    isDragging = true;
                    offsetX = e.clientX - element.getBoundingClientRect().left;
                    offsetY = e.clientY - element.getBoundingClientRect().top;

                    element.style.zIndex = '1000';
                    element.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;

                    const canvas = document.getElementById('canvasArea');
                    const canvasRect = canvas.getBoundingClientRect();

                    const x = e.clientX - canvasRect.left - offsetX;
                    const y = e.clientY - canvasRect.top - offsetY;

                    element.style.left = `${Math.max(0, x)}px`;
                    element.style.top = `${Math.max(0, y)}px`;
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    element.style.cursor = 'move';
                    element.style.zIndex = '1';
                });
            }

            showModal(title, content) {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;

                // Create modal content
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: var(--nexus-surface);
                    border-radius: 16px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    border: 2px solid var(--nexus-cyan);
                `;

                modal.innerHTML = `
                    <h2 style="margin-bottom: 20px; color: var(--nexus-cyan);">${title}</h2>
                    ${content}
                    <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="position: absolute; top: 20px; right: 20px; background: transparent; color: var(--nexus-text-secondary); border: none; font-size: 24px; cursor: pointer;">√ó</button>
                    <button onclick="this.closest('[style*=&quot;position: fixed&quot;]').remove()" style="position: absolute; top: 20px; right: 20px; background: transparent; color: var(--nexus-text-secondary); border: none; font-size: 24px; cursor: pointer;">√ó</button>
                `;

                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                // Store reference for close function
                overlay.closeModal = () => overlay.remove();
                window.closeModal = () => overlay.remove();
            }

            closeModal() {
                const modal = document.querySelector('[style*="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8)"]');
                if (modal) modal.remove();
            }

            showToast(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: 100px;
                    right: 20px;
                    background: var(--nexus-surface);
                    color: var(--nexus-cyan);
                    padding: 12px 20px;
                    border-radius: 8px;
                    border: 1px solid var(--nexus-cyan);
                    z-index: 10001;
                    animation: slideInUp 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                `;
                toast.textContent = message;

                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideInUp 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.nexusStudio = new NexusStudioPWA();
        });

        // Helper functions for inline event handlers
        function openTab(tabName) {
            if (window.nexusStudio) {
                window.nexusStudio.openTab(tabName);
            }
        }

        function connectAPI(provider) {
            if (window.nexusStudio) {
                window.nexusStudio.showModal(`Connect ${provider}`, `
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--nexus-text-secondary);">API Key</label>
                        <input type="password" id="apiKey" style="width: 100%; padding: 10px; background: var(--nexus-surface); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: var(--nexus-text);" placeholder="Enter your ${provider} API key">
                    </div>

                    <div style="font-size: 12px; color: var(--nexus-text-secondary); margin-bottom: 20px;">
                        üîí Your API key is encrypted and stored locally. It never leaves your browser.
                    </div>

                    <button id="saveApiKey" style="width: 100%; background: var(--nexus-cyan); color: var(--nexus-bg); border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Save & Connect
                    </button>
                `);

                document.getElementById('saveApiKey').addEventListener('click', () => {
                    const key = document.getElementById('apiKey').value;
                    if (key) {
                        window.nexusStudio.showToast(`‚úÖ ${provider} API connected`);
                        window.nexusStudio.closeModal();
                    }
                });
            }
        }
    </script>
</body>
</html>
